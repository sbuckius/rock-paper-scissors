<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Rock Paper Scissors (Cute Style)</title>
<style>
body {
  font-family: 'Comic Sans MS', 'Chalkboard SE', cursive;
  text-align: center;
  background: #fff0f5;
  margin: 0;
  padding: 20px;
}
h1 { color: #ff69b4; font-size: 2.5em; margin-bottom: 10px; }
h3 { color: #ff1493; margin-bottom: 5px; }
button {
  padding: 12px 24px;
  font-size: 16px;
  margin: 10px;
  border: none;
  border-radius: 12px;
  cursor: pointer;
  transition: transform 0.2s, box-shadow 0.2s;
  box-shadow: 2px 2px 6px rgba(0,0,0,0.2);
}
button:hover { transform: scale(1.1); box-shadow: 4px 4px 10px rgba(0,0,0,0.3); }
.join-btn { background-color: #90ee90; color: #fff; }
.joined { background-color: #ff7f7f !important; }
button.move-btn { background-color: #ffd1dc; color: #ff1493; }
button.move-btn:hover { background-color: #ffb6c1; }

#moves-status, #scores, #choices-output { margin-top: 20px; font-size: 18px; font-weight: bold; color: #ff69b4; }
#winner-text { margin-top: 20px; font-size: 36px; font-weight: bold; color: #ff1493; text-shadow: 2px 2px 10px #ffb6c1, 0 0 20px #ff69b4; }
#player-select, #join-buttons, #controls { margin: 20px 0; }
pre { font-family: 'Comic Sans MS', cursive; color: #ff69b4; }
</style>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, doc, setDoc, updateDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyAavjBl8_7rzWtXlEXLFxrn30lqteoA_aw",
  authDomain: "rock-paper-scissor-f380a.firebaseapp.com",
  projectId: "rock-paper-scissor-f380a",
  storageBucket: "rock-paper-scissor-f380a.firebasestorage.app",
  messagingSenderId: "854369078304",
  appId: "1:854369078304:web:50e5167370bc99536a0045",
  measurementId: "G-PPY3L3ZCLN"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let gameId = "game1";
let playerRole = null;
let totalPlayers = 0;
let roundActive = false; // <-- prevents repeated score increments
const gameRef = doc(db, "games", gameId);

// Select number of players
window.selectPlayers = async function(num) {
  totalPlayers = num;
  document.getElementById('player-select').style.display = 'none';
  const joinContainer = document.getElementById('join-buttons');
  joinContainer.innerHTML = '';
  for (let i = 1; i <= num; i++) {
    const btn = document.createElement('button');
    btn.className = 'join-btn';
    btn.innerText = `Player ${i}`;
    btn.onclick = () => joinGame(`player${i}`, btn);
    joinContainer.appendChild(btn);
  }
  await resetGameData();
};

// Join Game
window.joinGame = function(role, btn) {
  playerRole = role;
  document.getElementById("status").innerText = "You are " + role;

  document.querySelectorAll('.join-btn').forEach(b => b.classList.remove('joined'));
  btn.classList.add('joined');
};

// Play Move
window.playMove = async function(choice) {
  if (!playerRole) { alert("Join a player first!"); return; }

  // Instant UI update
  const movesStatusEl = document.getElementById("moves-status");
  const lines = movesStatusEl.innerText.split("\n");
  const playerIndex = lines.findIndex(line => line.startsWith(playerRole));
  if (playerIndex >= 0) lines[playerIndex] = `${playerRole}: Selected ‚úÖ`;
  movesStatusEl.innerText = lines.join("\n");

  // Save move to Firestore
  await setDoc(gameRef, { moves: { [playerRole]: choice } }, { merge: true });
};

// New Game
window.newGame = async function() {
  await resetGameData();
  document.getElementById("winner-text").innerText = '';
};

// Reset game data helper
async function resetGameData() {
  let scores = {};
  for (let i = 1; i <= totalPlayers; i++) scores[`player${i}`] = 0;
  await setDoc(gameRef, { scores, moves: {} }, { merge: true });

  // Reset moves-status
  const statusText = Array.from({ length: totalPlayers }, (_, i) => `player${i+1}: Waiting‚Ä¶`).join("\n");
  document.getElementById("moves-status").innerText = statusText;

  document.getElementById("choices-output").innerText = '';
  document.getElementById("winner-text").innerText = '';
  document.getElementById("scores").innerText = Object.keys(scores).map(p => `${p.toUpperCase()}: ${scores[p]}`).join('  ');

  document.querySelectorAll('.join-btn').forEach(b => b.classList.remove('joined'));
  if (playerRole) {
    const btn = Array.from(document.querySelectorAll('.join-btn')).find(b => b.innerText.includes(playerRole.slice(-1)));
    if (btn) btn.classList.add('joined');
  }

  roundActive = false; // allow new round
}

// Listen for game updates
onSnapshot(gameRef, async (docSnap) => {
  if (!docSnap.exists()) return;
  const data = docSnap.data();
  const moves = data.moves || {};
  const scores = data.scores || {};

  // Update scores display
  document.getElementById("scores").innerText =
    `Scores:\n` + Object.keys(scores).map(p => `${p.toUpperCase()}: ${scores[p]}`).join('  ');

  // Update moves status for other players
  const movesStatusEl = document.getElementById("moves-status");
  const lines = movesStatusEl.innerText.split("\n").map(line => {
    const player = line.split(":")[0];
    if (moves[player]) return `${player}: Selected ‚úÖ`;
    return line;
  });
  movesStatusEl.innerText = lines.join("\n");

  // Only process round once
  if (!roundActive && Object.keys(moves).length === totalPlayers) {
    roundActive = true; // mark round as processed
    const result = determineWinner(moves);
    const winnerTextEl = document.getElementById("winner-text");
    winnerTextEl.innerText = result.text;

    document.getElementById("choices-output").innerText =
      `Choices:\n` + Object.keys(moves).map(p => `${p}: ${moves[p]}`).join('\n');

    // Update scores
    if (result.winners.length > 0) {
      const newScores = { ...scores };
      result.winners.forEach(w => newScores[w] = (newScores[w] || 0) + 1);
      await updateDoc(gameRef, { scores: newScores });
    }

    // Reset moves after 3 seconds
    setTimeout(async () => {
      await updateDoc(gameRef, { moves: {} });
      const statusText = Array.from({ length: totalPlayers }, (_, i) => `player${i+1}: Waiting‚Ä¶`).join("\n");
      document.getElementById("moves-status").innerText = statusText;
      document.getElementById("choices-output").innerText = '';
      winnerTextEl.innerText = '';
      roundActive = false; // allow next round
    }, 3000);
  }
});

// Winner logic for 2 or 3 players
function determineWinner(moves) {
  const beats = { Rock: "Scissors", Paper: "Rock", Scissors: "Paper" };
  const moveCounts = {};
  const winners = [];

  Object.values(moves).forEach(move => {
    moveCounts[move] = (moveCounts[move] || 0) + 1;
  });

  const uniqueMoves = Object.keys(moveCounts);

  if (uniqueMoves.length === 1 || uniqueMoves.length === 3) return { text: "Tie! üíñ", winners: [] };

  const [moveA, moveB] = uniqueMoves;
  const winningMove = beats[moveA] === moveB ? moveA : moveB;

  Object.keys(moves).forEach(player => {
    if (moves[player] === winningMove) winners.push(player);
  });

  return { text: winners.join(", ") + " win! üéâ", winners };
}
</script>
</head>
<body>
<h1>Rock Paper Scissors üéÄ</h1>

<div id="player-select">
  <h3>Select number of players:</h3>
  <button onclick="selectPlayers(2)">2 Players</button>
  <button onclick="selectPlayers(3)">3 Players</button>
</div>

<div id="join-buttons"></div>

<h3>Select Rock, Paper, or Scissors:</h3>
<button class="move-btn" onclick="playMove('Rock')">üå∏ Rock</button>
<button class="move-btn" onclick="playMove('Paper')">üçí Paper</button>
<button class="move-btn" onclick="playMove('Scissors')">üç• Scissors</button>

<div id="controls">
  <h3>Controls:</h3>
  <button onclick="newGame()">‚ú® New Game ‚ú®</button>
</div>

<h3 id="status"></h3>
<pre id="moves-status"></pre>
<h3 id="scores"></h3>
<h3 id="winner-text"></h3>
<pre id="choices-output"></pre>

</body>
</html>
